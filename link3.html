<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HPC CFD Engine - 3D Rayleigh-Bénard Convection</title>

    <!-- Importing a new, modern font: Space Mono -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">

    <!-- MathJax for LaTeX typesetting -->
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        /* General body styles for a light, minimalist theme */
        body {
            font-family: 'Space Mono', monospace;
            background-color: #f0f0f0;
            color: #111;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Dark theme styles */
        body.dark-theme {
            background-color: #111;
            color: #f0f0f0;
        }

        body.dark-theme .tutorial-content { border-top: 1px solid #444; }
        body.dark-theme pre { background-color: #222; }
        body.dark-theme .theme-toggle-button { color: #f0f0f0; border-color: #f0f0f0; }
        body.dark-theme .theme-toggle-button:hover { background-color: #f0f0f0; color: #111; }
        body.dark-theme .equation-block { border-left: 3px solid #7cb3ff; background-color: #222; }
        body.dark-theme figcaption { color: #ccc; }

        /* Container for the main content */
        .container {
            flex-grow: 1;
            padding: clamp(30px, 5vw, 50px);
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
            position: relative;
        }

        /* --- Main Text Section --- */
        .main-content h1 {
            font-family: 'Space Mono', monospace;
            font-size: clamp(3rem, 10vw, 7rem);
            line-height: 1;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 5px;
            color: #111; /* Changed to match theme */
        }

        /* --- Tutorial Section Styles --- */
        .tutorial-content {
            margin-top: clamp(50px, 10vw, 100px);
            padding-top: clamp(25px, 5vw, 50px);
            border-top: 1px solid #c0c0c0;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: clamp(20px, 5vw, 40px);
        }

        .tutorial-content p { line-height: 1.6; max-width: 800px; }
        .tutorial-content h2, .tutorial-content h3, .tutorial-content h4 { font-weight: 700; text-transform: uppercase; }
        .tutorial-content h2 { font-size: clamp(1.5rem, 4vw, 2rem); letter-spacing: 2px; }
        .tutorial-content h3 { font-size: clamp(1rem, 2vw, 1.2rem); margin-top: 2rem; margin-bottom: 1rem; }

        pre { background-color: #e5e7eb; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word; width: 100%; box-sizing: border-box; }
        pre code { font-size: 0.9rem; }

        /* Style for LaTeX equations */
        .equation-block {
            padding: 10px;
            margin: 1.5rem 0;
            border-left: 3px solid #007bff;
            background-color: #f8f9fa;
        }

        /* Image/Visualization Styling (Placeholder for RT Simulation) */
        .viz-container {
            width: 100%;
            max-width: 800px;
            margin: 20px auto; /* Centering the visualization */
            border: 1px solid #ccc;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 0;
        }

        body.dark-theme .viz-container { border-color: #444; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }


        .viz-container img {
            width: 100%;
            height: auto;
            display: block;
            min-height: 200px; /* Ensure placeholder visibility */
        }

        .viz-container figcaption {
            padding: 10px;
            font-size: 0.8rem;
            text-align: center;
            background-color: #f8f8f8;
        }

        body.dark-theme .viz-container figcaption {
            background-color: #282828;
        }


        /* --- Footer and Theme Toggle --- */
        footer {
            margin-top: auto;
            padding: 30px clamp(30px, 5vw, 50px);
            border-top: 1px solid #c0c0c0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .theme-toggle-button {
            background: none; border: 1px solid #111; color: #111; padding: 8px 16px;
            font-family: 'Space Mono', monospace; font-size: 0.9rem; cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease; border-radius: 5px;
            display: flex; align-items: center; gap: 8px; text-transform: uppercase;
        }

        .theme-toggle-button:hover { background-color: #111; color: #f0f0f0; }
        .dark-theme .theme-toggle-button { border: 1px solid #f0f0f0; color: #f0f0f0; }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container { padding: 30px; text-align: center; align-items: center; }
            footer { flex-direction: column; justify-content: center; align-items: center; gap: 10px; }
            .main-content h1 { letter-spacing: 2px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Main content area -->
        <div class="main-content">
            <h1>CFD HPC STACK</h1>
        </div>

        <!-- Tutorial Section (Core Technical Content) -->
        <main class="tutorial-content">
            <h2 class="books-title">3D Rayleigh-Bénard Convection: Thermal Plumes and Cells</h2>
            <p class="text-sm text-gray-500">A guide to developing a high-performance solver for buoyancy-driven heat transfer, focusing on 3D Rayleigh-Bénard (RB) convection using C++ and high-level scripting.</p>

            <div class="content-section">
                <p>
                    Rayleigh-Bénard (RB) convection studies the flow and heat transfer in a fluid layer heated from below and cooled from above, driven by density differences. This process leads to the spontaneous formation of complex, time-dependent convection patterns, such as rolls or polygonal cells, which are characterized by the dimensionless **Rayleigh number** ($Ra$).
                </p>

                <!-- Visualization Placeholder for RB Simulation -->
                <div class="viz-container">
                    <img src="taylorvortex.png"
                         alt="Animated simulation showing the evolution of 3D Rayleigh-Bénard convection cells."
                         onerror="this.onerror=null; this.src='https://placehold.co/800x400/2ecc71/white?text=Visualization+Not+Available+Use+Image+Tag';"/>
                    <figcaption>Conceptual visualization of 3D Rayleigh-Bénard convection showing cold plumes (blue) descending and hot plumes (red) ascending, forming convection cells.</figcaption>
                </div>
                <!-- End Visualization -->

                <h3>1. Governing Equations in Conservation Form</h3>
                <p>
                    For a Finite Volume discretization, the equations are typically integrated over a control volume ($\Omega$) to express conservation of momentum and energy. The Boussinesq approximation is still used, allowing density changes only in the gravitational term.
                </p>

                <h4 id="navier-stokes">Incompressible Navier-Stokes Equations (Momentum with Buoyancy)</h4>
                <div class="equation-block">
                    $$
                    \frac{\partial}{\partial t} \int_{\Omega} \mathbf{u} dV + \int_{\partial \Omega} \mathbf{u} (\mathbf{u} \cdot \mathbf{n}) dA = - \int_{\Omega} \nabla p dV + \int_{\Omega} Pr \nabla^2 \mathbf{u} dV + \int_{\Omega} \mathbf{e}_z Ra Pr T dV \quad \text{(Momentum, Integral Form)}
                    $$
                    $$
                    \int_{\partial \Omega} \mathbf{u} \cdot \mathbf{n} dA = 0 \quad \text{(Continuity, Integral Form)}
                    $$
                </div>

                <h4 id="energy-transport">Energy Transport Equation (Integral Form)</h4>
                <p>
                    The integral form of the energy equation states that the rate of change of thermal energy within the control volume equals the net flux of energy across the boundary (convection) plus the net thermal diffusion within the volume.
                </p>
                <div class="equation-block">
                    $$
                    \frac{\partial}{\partial t} \int_{\Omega} T dV + \int_{\partial \Omega} T (\mathbf{u} \cdot \mathbf{n}) dA = \int_{\Omega} \nabla^2 T dV \quad \text{(Energy Transport, Integral Form)}
                    $$
                </div>

                <h3>2. High-Level Scripting with Julia (3D RB Setup)</h3>
                <p>
                    The following conceptual Julia script, using the `IncompressibleNavierStokes` package, demonstrates how to define the 3D domain, set the Rayleigh and Prandtl numbers, and apply the initial thermal perturbation required to trigger the instability.
                </p>
                <pre class="code-snippet"><code class="language-julia">// 3D Rayleigh-Bénard Convection - Julia Script (Conceptual Setup)
# Fluid layer heated from below (T=1) and cooled from above (T=0).

using GLMakie
using IncompressibleNavierStokes
using LinearAlgebra

# Set up physical parameters and grid size
Pr = 0.71   # Prandtl number for air
Ra = 1.0e6  # Rayleigh number (highly unstable regime)
T = Float64
n = 64      # Resolution in each dimension (n x n x n grid)

# Grid setup (e.g., cubic domain of size 1x1x1)
x = (LinRange(T(0), T(1), n+1), LinRange(T(0), T(1), n+1), LinRange(T(0), T(1), n+1))
backend = IncompressibleNavierStokes.CPU()

# Define the temperature model, setting gdir=3 for gravity in the Z-direction
temperature = temperature_equation(;
    Pr = T(Pr),
    Ra = T(Ra),
    gdir = 3, # Buoyancy acts along the Z-axis
    boundary_conditions = ((DirichletBC(), DirichletBC()), (DirichletBC(), DirichletBC()), (DirichletBC(), DirichletBC())),
)

# Overall setup: Re is often set to 1.0 in non-dimensional RB
setup = Setup(;
    x,
    boundary_conditions = ((DirichletBC(), DirichletBC()), (DirichletBC(), DirichletBC()), (DirichletBC(), DirichletBC())),
    Re = 1.0, 
    temperature,
);

# Initial conditions: small perturbation on a stable linear temperature profile
ustart = velocityfield(setup, (dim, x, y, z) -> zero(x));

# Linear profile: T=1 at z=0 (bottom, hot) to T=0 at z=1 (top, cold)
T_linear(z) = (1.0 - z) 

# Add a small, high-frequency perturbation to break symmetry
T_pert(x, y, z) = T_linear(z) + 0.01 * sin(2π * x) * cos(2π * y) * exp(-10 * (z - 0.5)^2) 
tempstart = temperaturefield(setup, (x, y, z) -> T_pert(x, y, z));

# The full solve_unsteady call would proceed here...
// End of Julia Script.</code></pre>

                <h3>3. C++ Implementation Detail (3D Buoyancy Kernel)</h3>
                <p>
                    In the C++ solver, the buoyancy force is calculated for every cell in the domain, typically within a parallel kernel (like CUDA) that updates the source term of the Z-momentum equation based on the local temperature deviation. This source term is then integrated over the control volume during discretization.
                </p>
                <pre class="code-snippet"><code class="language-cpp">// cfd_rb_kernel.cpp: Conceptual CUDA Kernel for Buoyancy Source Term (3D)
#include <cmath>

// Define non-dimensional constants used by the kernel
#define RA_PR_PRODUCT 1.0e6 * 0.71 // Ra * Pr (from setup)
#define T_REF 0.5                  // Reference temp, often the mean (T_hot + T_cold) / 2

/**
 * @brief Computes the buoyancy source term for the Z-momentum equation in 3D RB.
 *
 * @param d_t_field Pointer to the Temperature field on the GPU.
 * @param d_f_source_z Pointer to the Z-momentum source term array on the GPU.
 * @param N_TOTAL Total number of grid points (NX * NY * NZ).
 */
__global__ void buoyancy_kernel_3D(
    const double* d_t_field,
    double* d_f_source_z,
    const int N_TOTAL)
{
    // Map thread index to grid index (Highly optimized for GPU execution)
    int idx = blockIdx.x * blockDim.x + threadIdx.x;
    
    if (idx < N_TOTAL) {
        
        // Non-dimensional buoyancy force is Fz = Ra * Pr * T'
        // where T' is the deviation from the mean temperature T_REF.
        double T_current = d_t_field[idx];
        double T_deviation = T_current - T_REF; 

        // T_current > T_REF (hotter/lighter) -> Positive Z force (Upward plume)
        // T_current < T_REF (colder/heavier) -> Negative Z force (Downward plume)
        d_f_source_z[idx] = RA_PR_PRODUCT * T_deviation; 
    }
}
// End of C++ Source Term.</code></pre>

            </div>
        </main>
    </div>

    <!-- The Footer remains outside the container to span full width -->
    <footer>
        <p>© 2025 HPC-CFD Technical Document.</p>
        <!-- Theme Toggle Button -->
        <button id="theme-toggle" class="theme-toggle-button">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
            <span id="theme-text">Dark Mode</span>
        </button>
    </footer>

    <!-- JavaScript for Theme Toggle Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const body = document.body;
            const toggleButton = document.getElementById('theme-toggle');

            // --- Theme Toggle Logic ---
            const isDarkMode = localStorage.getItem('theme') === 'dark';

            const updateThemeUI = (isDark) => {
                if (isDark) {
                    body.classList.add('dark-theme');
                    toggleButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg><span>Light Mode</span>`;
                } else {
                    body.classList.remove('dark-theme');
                    toggleButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg><span>Dark Mode</span>`;
                }
            };

            updateThemeUI(isDarkMode);

            toggleButton.addEventListener('click', () => {
                const isDark = body.classList.toggle('dark-theme');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                updateThemeUI(isDark);
            });
        });
    </script>
</body>
</html>